# Final assignment github repository.

MDGE 610: Foundations of Bioinformatics.

Dorian Rojas Villalta; Ph.D. Student.

## Overview

This github contains the [written report](Written_report.pdf) and 
[output data](empiricalInvestigation) for the final assignment of MDGE 610.

### Contents

| Path | Description |
|------|-------------|
| `assignment_handout.pdf` | Assignment instructions |
| `Written_report.pdf` | Rendered written report |
| `Written_report.qmd` | Source quarto file of written report |
| `log-likelihood_function_kallisto.png` | Figure 1 of written report |
| `kallisto @ 4e9f29c/` | Submodule of kallisto repository |
| `empiricalInvestigation/EMAlgorithm.h` | Mirror EM algorithm to local kallisto |
| `empiricalInvestigation/gencode.v44.kidx` | Pre-built kallisto index (GENCODE v44 protein-coding transcripts) |
| `empiricalInvestigation/sim_true_counts.txt` | Ground truth transcript counts |
| `empiricalInvestigation/00-raw-data/sim_reads_1.fastq.gz` | Simulated paired-end reads (read 1) |
| `empiricalInvestigation/00-raw-data/sim_reads_2.fastq.gz` | Simulated paired-end reads (read 2) |
| `empiricalInvestigaction/*-output/` | kallisto trial outputs |

The final written report was generated using Quarto in RStudio and rendered in 
pdf. Both the `.qmd` and `.pdf` files can be found in this repository. The responses 
to assignment questions, detailed methods description, and pertinent empirical investigation code
can be found on these documents. 

The empirical investigation was conducted on a set of simulated data generated by 
the class professor Dr. Jason de Koning. These files were directly downloaded from the
[assignment repository](https://github.com/jasondk/mdge610-kallisto/tree/main) without git cloning.
Details of simulated data are described below:

- **Reference**: GENCODE v44 human protein-coding transcriptome (110,962 transcripts)
- **Read pairs**: 1,000,000
- **Read length**: 75 bp paired-end
- **Fragment length**: Mean 250 bp, SD 50 bp
- **Sequencing error**: 1% per-base

## Local installation of kallisto

The kallisto software was installed locally on a MacBook Air with Apple M4 10 cores 
and 16GB of RAM. The software implementation was conducted using the following commands:

  ```bash
  # Installing prerequired tools
  ## Git LFS
  brew install git-lfs
  git lfs install
  
  ## CMake
  brew install cmake
  
  # Iniial copy of kallisto
  ## Cloning repository
  git clone https://github.com/pachterlab/kallisto.git
  
  ## Commiting as a submodule
  git submodule add https://github.com/pachterlab/kallisto.git kallisto
  git commit -m 'Original Kallisto'
  git push origin main
  
  ## Copy EMAlgorithm.h mirror file
  cp kallisto/src/EMAlgorithm.h .
  mv EMAlgorithm.h empiricalInvestigation 
  git commit -m 'Original EM algorithm code'
  git push origin main
  
  # Installion of local kallisto software
  ## Removing incompatibility arguments (x86-only -mno-avx2 flag)
  cd kallisto
  sed -i '' 's/-mno-avx2//g' ext/bifrost/CMakeLists.txt
  
  ## Fix the DataStorage.tcc typo (see #488)
  sed -i '' 's/o\.sz_link\[i\]\.load()/o.unitig_cs_link[i].load()/' ext/bifrost/src/DataStorage.tcc
  
  ## Configure
  mkdir build && cd build
  CMAKE_POLICY_VERSION_MINIMUM=3.5 cmake .. -DENABLE_AVX2=OFF -DCOMPILATION_ARCH=OFF -DCMAKE_POLICY_VERSION_MINIMUM=3.5
  
  ## Build (|| handles a possible race condition on first run)
  CMAKE_POLICY_VERSION_MINIMUM=3.5 make -j$(sysctl -n hw.ncpu) || make -j$(sysctl -n hw.ncpu)
  
  ## Verification
  ./src/kallisto version 
    #> kallisto, version 0.51.1
  ```
> Note: several modification were made over the installation instructions to fit the computational 
allocation. The author thanks the Dr. Jason de Koning for the help provided over the solution to these issues. 
To see the original installation instructions refer to the [kallisto GitHub repository](https://github.com/pachterlab/kallisto).

The [kallisto folder](https://github.com/pachterlab/kallisto) in this repository is a submodule of the original repository. 
Thus, a copy of the [expectation-maximization (EM) algorithm](/empiricalInvestigation/EMAlgorithm.h) was created allowing for 
direct modification and track changes of the pertinent convergence criteria alterations for the purpose of this assignment. 
This document represents a mirror of the local modified code.

## Brief assignment methods

This assignment aims to understand the effect of convergence criteria thresholds into
the relative difference between simulated data and their ground truth. 
For this, the minimum threshold of abundance (`alpha_change_limit`) 
and maximum variance between iterations (`alpha_change`) were modified in the 
`EMAlgorithm.h` file. Each parameter setting was defined with an alphabet letter 
(abundance threshold = A-E; variance threshold = Z-V) and a paired combination 
was assigned as output folder prefix for tracking purposes. Specific parameter 
values definition and assigned letters combinations are stated below.

|         |A (1.0)|B (0.1)|C (0.01; default)|D (0.001)|E (0.0001)|
|:--------|:-----:|:-----:|:---------------:|:-------:|:--------:|
| **V (2.0)** | AV | BV |     CV      | DV | EV |
| **W (1.5)** | AW | BW |     CW      | DW | EW |
| **X (1.0; default)** | AX | BX |     CX      | DX | EX |
| **Y (0.5)** | AY | BY |     CY      | DY | EY |
| **Z (0.1)** | AZ | BZ |     CZ      | DZ | EZ |

The relative difference between estimated transcript counts and
ground truth were assessed using false positives, 
correlation, and root mean square error (RMSE) analyses.

## Main findings 

- Decreasing the minimum abundance threshold reduces EM-algorithm conservative 
measures (less stringent), leading to a higher number of false positives. Also, 
this increases the number of iterations required to achieve convergence in the 
maximum likelihood estimates. 

- Convergence criteria settings here tested resulted in small, almost neglectable,
changes in both correlation coefficient and RMSE analysis. Beyond this, less 
stringent parameters resulted in higher values of these tests.

- Higher number of iteration in the EM-algorithm result in higher RMSE, 
indicating more difference between estimated values to ground truth.

- Overall, the here tested modifications to EM-algorithm convergence criteria 
do not seem to have an strong effect in relative differences between estimated 
data and true values. However, using less stringent setting might result in an 
increase number of false positives

## Acknowledgements

This assignment is dedicated to David Rojas Rodr√≠guez, who heard the author
talk about expectation-maximization and equivalence classes for over a week. He 
said to have enjoyed listening to audio messages about the topic as a podcast while 
doing the dishes.
